# 智能配票算法使用指南

## 1. 核心概念

### 1.1 票据（Ticket）
票据是系统中的基本资源单位，包含以下属性：
- **id**: 唯一标识符
- **amount**: 票据面额（元）
- **maturity_days**: 到期天数
- **acceptor_class**: 承兑人分类（1-5，数字越小越好）
- **amount_label**: 金额标签（大额/中额/小额，自动分类）
- **organization**: 承兑组织
- **available_amount**: 可用金额（初始等于面额，使用后扣减）

### 1.2 付款单（PaymentOrder）
付款单表示一个支付需求，包含：
- **id**: 订单标识
- **amount**: 需要支付的金额
- **organization**: 付款组织
- **priority**: 优先级（数字越大越优先，用于批量配票）

### 1.3 分配结果（AllocationResult）
算法执行后返回的结果，包含：
- 选中的票据列表及使用明细
- 总使用金额和差额
- 综合得分和约束满足情况
- 警告信息

## 2. 配置详解

### 2.1 金额标签配置（AmountLabelConfig）

定义票据的金额分类标准和期望库存占比。

```python
from src import AmountLabelConfig

config = AmountLabelConfig(
    large_range=(1000000, float('inf')),  # 大额：≥100万
    medium_range=(100000, 1000000),        # 中额：10万-100万
    small_range=(0, 100000),               # 小额：<10万
    large_ratio=0.5,                       # 期望大额占比50%
    medium_ratio=0.3,                      # 期望中额占比30%
    small_ratio=0.2,                       # 期望小额占比20%
)
```

### 2.2 权重配置（WeightConfig）

定义四个维度的权重和策略。

```python
from src import (
    WeightConfig,
    MaturityStrategy,
    AcceptorClassStrategy,
    AmountStrategy,
    OrganizationStrategy,
)

config = WeightConfig(
    # 权重（总和必须为1）
    w_maturity=0.25,        # 到期期限权重
    w_acceptor=0.25,        # 承兑人分类权重
    w_amount=0.25,          # 金额策略权重
    w_organization=0.25,    # 承兑组织权重
    
    # 到期期限策略
    maturity_strategy=MaturityStrategy.FAR_FIRST,  # 优先远期
    maturity_threshold=90,                          # 阈值90天
    
    # 承兑人分类策略
    acceptor_strategy=AcceptorClassStrategy.BAD_FIRST,  # 优先差的
    acceptor_class_count=5,                              # 分类总数
    
    # 金额策略
    amount_strategy=AmountStrategy.OPTIMIZE_INVENTORY,  # 优化库存
    
    # 承兑组织策略
    organization_strategy=OrganizationStrategy.SAME_ORG,  # 优先同组织
)
```

#### 到期期限策略选项
- `MaturityStrategy.FAR_FIRST`: 优先远期票据
- `MaturityStrategy.NEAR_FIRST`: 优先近期票据

#### 承兑人分类策略选项
- `AcceptorClassStrategy.GOOD_FIRST`: 优先好的承兑人
- `AcceptorClassStrategy.BAD_FIRST`: 优先差的承兑人

#### 金额策略选项
- `AmountStrategy.LARGE_FIRST`: 大额优先
- `AmountStrategy.SMALL_FIRST`: 小额优先
- `AmountStrategy.RANDOM`: 金额随机
- `AmountStrategy.LESS_THAN_ORDER`: 整票金额≤付款单金额
- `AmountStrategy.GREATER_THAN_ORDER`: 单票金额≥付款单金额
- `AmountStrategy.OPTIMIZE_INVENTORY`: 优化期望库存占比

#### 承兑组织策略选项
- `OrganizationStrategy.SAME_ORG`: 优先同组织
- `OrganizationStrategy.DIFF_ORG`: 优先不同组织

### 2.3 拆票配置（SplitConfig）

控制票据拆分行为。

```python
from src import SplitConfig, SplitStrategy

config = SplitConfig(
    allow_split=True,                      # 是否允许拆票
    tail_diff_abs=10000,                   # 绝对尾差阈值（元）
    tail_diff_ratio=0.3,                   # 相对尾差阈值（30%）
    min_remain=50000,                      # 拆票后最小留存金额
    min_use=50000,                         # 拆票最小使用金额
    min_ratio=0.3,                         # 拆票最小使用比例
    split_strategy=SplitStrategy.BY_AMOUNT_CLOSE,  # 拆票选择策略
    split_condition_unlimited=False,       # 是否无限制拆分
)
```

**尾差阈值说明**：
- 实际阈值 = max(tail_diff_abs, order_amount × tail_diff_ratio)
- 当差额在阈值内时，可选择电汇补齐（不拆票）

**拆票策略选项**：
- `SplitStrategy.BY_MATURITY`: 按到期期限选择
- `SplitStrategy.BY_ACCEPTOR_CLASS`: 按承兑人分类选择
- `SplitStrategy.BY_AMOUNT_LARGE`: 按金额大额优先
- `SplitStrategy.BY_AMOUNT_CLOSE`: 按接近差额选择

### 2.4 约束配置（ConstraintConfig）

定义各种业务约束。

```python
from src import ConstraintConfig

config = ConstraintConfig(
    max_ticket_count=10,                   # 单张付款单最大票据数
    small_ticket_limited=True,             # 是否启用小额票限制
    small_ticket_80pct_amount_coverage=0.5,  # 小额票前80%覆盖度要求
    
    # 票据过滤条件（可选）
    allowed_maturity_days=(30, 180),       # 允许的到期天数范围
    allowed_amount_range=(10000, 5000000), # 允许的金额范围
    allowed_acceptor_classes=[1, 2, 3],    # 允许的承兑人分类
)
```

**小额票限制说明**：
当启用时，要求：
- 将选中的小额票按金额从小到大排序
- 前80%张数的票据累计金额 ≥ 付款单金额 × coverage_ratio

## 3. 典型使用场景

### 3.1 场景一：优先库存均衡

目标：平衡库存结构，避免某类票据积压。

```python
from src import AllocationConfig, WeightConfig, AmountStrategy
from src.utils import create_tickets_from_data

# 配置：金额策略权重最高
config = AllocationConfig(
    weight_config=WeightConfig(
        w_maturity=0.1,
        w_acceptor=0.2,
        w_amount=0.6,        # 金额策略权重最高
        w_organization=0.1,
        amount_strategy=AmountStrategy.OPTIMIZE_INVENTORY,
    )
)

engine = AllocationEngine(config=config)
result = engine.allocate(order, tickets)
```

### 3.2 场景二：优先消耗差票

目标：优先使用承兑人分类差的票据。

```python
from src import WeightConfig, AcceptorClassStrategy

config = AllocationConfig(
    weight_config=WeightConfig(
        w_acceptor=0.5,      # 承兑人权重最高
        w_maturity=0.2,
        w_amount=0.2,
        w_organization=0.1,
        acceptor_strategy=AcceptorClassStrategy.BAD_FIRST,
    )
)
```

### 3.3 场景三：快速精确匹配

目标：快速找到等额票据，避免拆票。

```python
config = AllocationConfig(
    equal_amount_first=True,      # 启用等额优先
    equal_amount_threshold=5000,  # 阈值5000元
    split_config=SplitConfig(
        allow_split=False,        # 禁止拆票
    )
)
```

### 3.4 场景四：灵活拆票

目标：允许灵活拆票，精确匹配金额。

```python
config = AllocationConfig(
    split_config=SplitConfig(
        allow_split=True,
        tail_diff_abs=100,          # 低阈值，几乎总是拆票
        min_remain=10000,           # 最小留存1万
        min_use=10000,              # 最小使用1万
        min_ratio=0.1,              # 最小比例10%
        split_condition_unlimited=True,  # 无限制拆分
    )
)
```

### 3.5 场景五：批量配票优化

目标：按优先级批量处理多个订单。

```python
orders = [
    PaymentOrder(id="O1", amount=1000000, organization="A", priority=10),
    PaymentOrder(id="O2", amount=500000, organization="B", priority=5),
    PaymentOrder(id="O3", amount=800000, organization="A", priority=8),
]

# 自动按priority排序处理
results = engine.allocate_batch(orders, tickets)

for result in results:
    print(f"订单{result.order_id}: 使用{result.ticket_count}张票")
```

## 4. 结果解读

### 4.1 查看分配方案

```python
from src.utils import format_allocation_result

result = engine.allocate(order, tickets)
pretty = format_allocation_result(result)

# 输出格式化结果
import json
print(json.dumps(pretty, ensure_ascii=False, indent=2))
```

### 4.2 关键指标

- **total_amount**: 总使用金额
- **bias_amount**: 差额（正数表示不足，负数表示超额）
- **total_score**: 综合得分（越高越优）
- **constraints_met**: 是否满足所有约束
- **warnings**: 警告信息列表

### 4.3 警告信息类型

- "等额配票成功": 找到等额票据
- "差额X在尾差阈值内，采用电汇补齐": 差额较小，无需拆票
- "补票拆分: ...": 新增票据并拆分
- "超额拆分: ...": 调整已选票据使用金额
- "无法补票/拆票": 无法满足拆票约束
- "票据张数超过限制": 违反数量约束
- "小额票...未达到要求": 违反小额票约束

## 5. 高级技巧

### 5.1 动态调整权重

根据不同付款单动态调整策略：

```python
def create_config_for_order(order):
    if order.amount > 1000000:  # 大额订单
        return AllocationConfig(
            weight_config=WeightConfig(
                w_amount=0.6,
                amount_strategy=AmountStrategy.LARGE_FIRST,
            )
        )
    else:  # 小额订单
        return AllocationConfig(
            weight_config=WeightConfig(
                w_amount=0.6,
                amount_strategy=AmountStrategy.SMALL_FIRST,
            )
        )
```

### 5.2 票据池管理

批量配票会自动更新票据池，也可手动管理：

```python
# 保存票据池快照
original_amounts = {t.id: t.available_amount for t in tickets}

# 执行配票
result = engine.allocate(order, tickets)

# 查看消耗
for ticket in tickets:
    used = original_amounts[ticket.id] - ticket.available_amount
    if used > 0:
        print(f"票据{ticket.id}使用{used}元")

# 恢复票据池（如需回滚）
for ticket in tickets:
    ticket.available_amount = original_amounts[ticket.id]
```

### 5.3 自定义得分计算

如需更复杂的得分逻辑，可修改 `src/scoring.py` 中的函数。

### 5.4 多策略对比

```python
strategies = [
    ("库存优化", AmountStrategy.OPTIMIZE_INVENTORY),
    ("大额优先", AmountStrategy.LARGE_FIRST),
    ("小额优先", AmountStrategy.SMALL_FIRST),
]

for name, strategy in strategies:
    config = AllocationConfig(
        weight_config=WeightConfig(amount_strategy=strategy)
    )
    # 重置票据池
    for t in tickets:
        t.available_amount = t.amount
    
    engine = AllocationEngine(config=config, seed=42)
    result = engine.allocate(order, tickets)
    print(f"{name}: 得分={result.total_score:.2f}, 张数={result.ticket_count}")
```

## 6. 故障排查

### 6.1 无可用票据
**现象**：`warnings` 包含 "无可用票据"

**可能原因**：
- 票据池为空
- 所有票据 `available_amount` 为0
- 过滤条件过严（检查 `ConstraintConfig`）

**解决方法**：
- 检查票据池状态
- 放宽 `allowed_*` 约束

### 6.2 差额过大
**现象**：`bias_amount` 绝对值很大

**可能原因**：
- 票据面额与订单金额不匹配
- 拆票被禁用或约束过严
- 票据池余额不足

**解决方法**：
- 启用拆票：`allow_split=True`
- 放宽拆票约束：降低 `min_remain`、`min_use`、`min_ratio`
- 补充票据池

### 6.3 违反约束
**现象**：`constraints_met=False`

**可能原因**：
- 票据数量超限
- 小额票覆盖度不足

**解决方法**：
- 增加 `max_ticket_count`
- 调整小额票配置或禁用限制

## 7. 性能优化

### 7.1 票据池规模
- 当前实现适用于票据数 ≤ 1000
- 大规模场景建议预过滤票据池

### 7.2 批量配票
- 批量配票比逐个调用更高效
- 票据池自动更新，避免重复选择

### 7.3 随机种子
- 设置 `seed` 参数可保证结果可复现
- 生产环境建议使用固定种子以便调试

```python
engine = AllocationEngine(config=config, seed=42)
```

## 8. API参考

完整API请参考各模块的文档字符串：

```python
from src import AllocationEngine
help(AllocationEngine.allocate)
```
