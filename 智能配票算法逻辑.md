# 业务目标
在票据池中选出不超过最大张数限制的票据子集（组合），使组合的总金额尽可能接近付款单金额M（接近的含义是可大于M也可小于M，大于M时做拆票，小于M时候可拆票可组合电汇补齐尾差），同时满足配票偏好、目标权重配置、拆票规则和约束条件。

# 票据可用范围
票据到期期限：可选项，如票据金额大于/等于/小于100W；
票据金额：可选项， 按月份，如大于等于3月或者当月； 按天，如大于30天；
票据承兑人分类：可选项，1～n类

# 票据标签
大额：金额范围mp1，期望库存占比sp1
中额：金额范围mp2，期望库存占比sp2
小额：金额范围mp3，期望库存占比sp3

# 选票偏好设置
是否优先等额配票（优先匹配和付款单金额等额或者接近的票据，当有多张候选等额票时，需要按照目标权重配置中的票据排序择优选取一个），可选项；
是否允许拆票，可选项；
最高权重维度是否强制穿透（如果强制穿透，则该维度不允许跨级用票，严格遵循配置的优先级用票，比如当设置了优先承兑人分类差的为最高权重，必须差的用完再用好的票。如果设置承兑人分类好的为最高权重，必须好的用完再用差的票。），可选项；

# 权重维度
票据到期期策略：（w1）：可选项，可选值：【"优先远-天数阈值T_far"，"优先近-天数阈值T_near"）】
承兑人分类(w2)：可选项，可选值【优先承兑人分类好的，优先承兑人分类差的】
        • 票据金额策略(w3)：可选项，可选值【大额优先、小额优先、金额随机、整票金额小于等于付款单金额、单票金额大于等于付款单金额、优化期望库存占比】
        • 如果金额策略=优化期望库存票据占比，则根据票据类型的库存分布和用户期望库存分布，计算得到票据类型偏好。比如用户期望票据分布为：{大额": 0.5, "中额": 0.4 "小额": 0.1},实际初始库存分布为{大额": 0.3, "中额": 0.5 "小额": 0.2}，则大额、中额、小额票据的优先消耗顺序和权重为：中票（权重：(0.5+0.1)/（0.5+0.1+0.2+0.1））>小票（权重：(0.2+0.1)/(0.5+0.1+0.2+0.1)）>大票（权重：0）；
        • 如果金额策略=大额优先，子策略有两种可选，分别是：大额内随机/大额内从大到小排序进行选票。
        • 如果金额策略=小额优先，子策略有两种可选，分别是：小额内随机/小额内从小到大排序进行选票。
        • 如果金额策略=金额随机，则随机选择票据；
        • 如果金额策略=整票金额小于等于付款单金额，则优选选择累计整票金额小于等于付款单金额的组合；
        • 如果金额策略=单票金额大于等于付款单金额，则优选选择单张票金额大于等于付款单金额的票据（期望最少用票）；
承兑组织(w4)：可选项，可选值【优先匹配票据和付款单同组织票据、优先匹配票据和付款单不同组织票据】


# 拆票规则（是否允许拆票=True时）
名词定义：
bias_amount：差额 = 付款单金额-当前票据总金额
tail_diff: 可选项，【尾差金额阈值（默认值1W），尾差占比域值（默认值30%）】
票据拆分条件：可选项，有两种类型，
1.无限制
2.差额范围内无需拆分：走电汇尾差补齐。判断条件：如果bias_amount（差额）大于0且bias_amount(差额) < tail_diff


# 票据拆分策略（拆分条件=无限制）:可选项
▪ 具体拆分规则： 
如果bias_amount（差额）大于0且bias_amount(差额) > tail_diff，则从票据池中选择一张新票进行拆分; 
如果bias_amount小于0，则从当前票据组合中选择一张票据进行拆分；拆票选票的策略遵循以下策略：
split_strategy：拆票选票策略，有三种维度： 分别是按到期期限、票据承兑人分类、票据金额维度。 其中票据到期期限、票据承兑人分类可以直接复用权重维度中的设置，票据金额维度可选大额优先和接近大于差额中的一种；

# 拆票约束：
票据拆分后结余（留存）金额大于等于某个范围）(默认值5万)；
票据拆分使用金额（差额）大于等于某个范围(默认值5万)；
票据拆分金额（使用金额）占整张票据比例大于某个值(默认值30%)；

# 票据数量约束
单张付款单做多可用票据张数： 可选项。是否允许浮动，张数可选项。
小额票张数是否有限制：可选项，如果有限制（需满足80%（张数）的票据累计金额必须要占据50%以上的的付款单金额）

## 数学建模设计
为便于统一求解，我们将配票视为带拆票逻辑的多目标混合整数规划（Mixed Integer Programming, MIP）问题，通过约束刻画业务规则，通过目标函数对多维偏好进行加权。

### 1. 集合与基础参数
- \(\mathcal{I} = \{1,\dots,n\}\)：候选票据集合。
- \(M\)：对应付款单金额。
- \(A_i\)：票据 \(i\) 的面额。
- \(d_i\)：票据 \(i\) 距离当前日期的到期天数。
- \(c_i\in\mathcal{C}\)：票据 \(i\) 的承兑人分类等级，集合 \(\mathcal{C}\) 按业务优先级从高到低排序。
- \(o_i\in\mathcal{O}\)：票据 \(i\) 的承兑组织。
- \(\ell_i\in\{L, M, S\}\)：票据 \(i\) 的金额标签（大额/中额/小额）。
- \(p_{\ell}\)：用户期望票据库存占比（针对 \(\ell \in \{L,M,S\}\)）。
- \(q_{\ell}\)：当前库存票据占比（同上）。
- \(T_{\text{far}}\)、\(T_{\text{near}}\)：到期日偏好的天数阈值。
- \(N_{\max}\)：单张付款单允许匹配的票据张数上限。
- \(\mathcal{I}_{\text{limit}} \subseteq \mathcal{I}\)：受可用范围限制（到期、金额、承兑人分类等筛选后）的票据集合。
- 拆票参数：
  - \(\underline{a}^{\text{split}}\)：拆票最小使用金额阈值（默认 5 万）。
  - \(\underline{r}^{\text{remain}}\)：拆票后剩余金额阈值（默认 5 万）。
  - \(\underline{\theta}^{\text{ratio}}\)：拆票金额占整票比例阈值（默认 30%）。
- 尾差控制参数：
  - \(\overline{\delta}^{\text{amt}}\)：尾差金额阈值（默认 1 万）。
  - \(\overline{\delta}^{\text{ratio}}\)：尾差占付款单金额的比例阈值（默认 30%）。
- 偏好与权重：
  - \(w_1, w_2, w_3, w_4\)：四个权重维度（到期、承兑分类、金额策略、承兑组织）的外部权重配置。
  - \(\alpha_0, \alpha_1, \alpha_2, \alpha_3, \alpha_4, \alpha_5\)：目标函数中不同子目标（金额贴合度、到期偏好、承兑人分类、金额策略、组织匹配、拆票惩罚）对应的调节系数，满足 \(\alpha_0 \gg \alpha_k\) 以实现层次化优化。
- 逻辑开关：
  - \(\text{allow\_split} \in \{0,1\}\)：是否允许拆票。
  - \(\text{force\_top}\in\{0,1\}\)：最高权重维度是否强制穿透。
  - \(\text{prefer\_equal}\in\{0,1\}\)：是否优先等额配票。

### 2. 决策变量
- \(x_i \in [0, A_i]\)：票据 \(i\) 被使用的金额，允许为 0、整票金额或部分金额。
- \(y_i \in \{0,1\}\)：票据 \(i\) 是否被选中（\(x_i>0\) 时取 1）。
- \(e_i \in \{0,1\}\)：票据 \(i\) 是否整票使用。
- \(s_i \in \{0,1\}\)：票据 \(i\) 是否产生拆票（部分使用），并满足 \(y_i = e_i + s_i\)。
- \(u,v \ge 0\)：付款金额偏差的正负偏差变量，使得 \(\sum_i x_i - M = u - v\)。
- \(r_{\text{tail}}\in\{0,1\}\)：是否走尾差电汇（\(r_{\text{tail}}=1\) 表示无需再选票据补齐差额）。
- \(g_{k,r} \in \{0,1\}\)：当最高权重维度强制穿透时，用于约束第 \(k\) 个维度中优先级第 \(r\) 档的使用开关。
- 其他辅助变量：根据金额策略的不同可能引入排序或惩罚变量（例如用于度量偏离“优化库存占比”目标的 \(\eta_{\ell}\)，用于线性化绝对值的 \(\xi\) 等）。

### 3. 目标函数
采用分层目标：
1. **一级目标（金额贴合度）**
   \[
   \min \; \alpha_0 (u + v)
   \]
   若配置了“优先等额配票”，可令 \(\alpha_0\) 足够大或附加约束 \(u+v \le \epsilon\)，其中 \(\epsilon\) 为允许的贴合误差。

2. **二级目标（偏好与权重评分）**
   \[
   \min \; \alpha_1 \Phi_{w_1} + \alpha_2 \Phi_{w_2} + \alpha_3 \Phi_{w_3} + \alpha_4 \Phi_{w_4} + \alpha_5 \Phi_{\text{split}}
   \]
   其中各分量可按以下方式构造：
   - 到期偏好：
     \[
     \Phi_{w_1} =
     \begin{cases}
       \sum_{i \in \mathcal{I}} y_i \cdot \max(0, T_{\text{far}} - d_i) & \text{若选择“优先远”}\ \\
       \sum_{i \in \mathcal{I}} y_i \cdot \max(0, d_i - T_{\text{near}}) & \text{若选择“优先近”}\ \\
       0 & \text{未配置}
     \end{cases}
     \]
   - 承兑人分类偏好：设 \(\text{rank}_{w_2}(c_i)\) 表示在当前策略下承兑等级 \(c_i\) 的优先级序号，则
     \(
       \Phi_{w_2} = \sum_i y_i \cdot \text{rank}_{w_2}(c_i)
     \)
     或者对低优先级票据施加惩罚权重。
   - 金额策略：
     - 若为“大额优先/小额优先”，通过给票据预设排序权重 \(\gamma_i\)（如 \(\gamma_i = -A_i\) 或 \(\gamma_i = A_i\)）并令 \(\Phi_{w_3} = \sum_i \gamma_i y_i\)。
     - 若为“金额随机”，令 \(\Phi_{w_3}=0\) 并在求解前随机打乱候选排序。
     - 若为“整票金额小于等于 M”，在约束中要求 \(e_i=1\) 时 \(A_i \le M\)，并设置 \(\Phi_{w_3}\) 惩罚违反者。
     - 若为“单票金额大于等于 M”，加入约束 \(y_i \Rightarrow A_i \ge M\) 或在目标中对不满足条件的票据加大惩罚。
     - 若为“优化期望库存占比”，设 \(r_{\ell} = \frac{\sum_{i:\ell_i=\ell} x_i}{\sum_i x_i}\)，通过引入对偶变量线性化 \(|r_{\ell} - p_{\ell}|\)，令 \(\Phi_{w_3} = \sum_{\ell} \eta_{\ell}\)，其中 \(\eta_{\ell} \ge r_{\ell} - p_{\ell}\)，\(\eta_{\ell} \ge p_{\ell} - r_{\ell}\)。
   - 承兑组织偏好：
     \(
       \Phi_{w_4} =
       \begin{cases}
         \sum_i y_i \cdot \mathbb{1}[o_i \ne o^{\text{pay}}] & \text{若优先同组织}\ \\
         \sum_i y_i \cdot \mathbb{1}[o_i = o^{\text{pay}}] & \text{若优先不同组织}
       \end{cases}
     \)
   - 拆票惩罚：
     \(\Phi_{\text{split}} = \sum_i s_i\)，或进一步考虑拆票金额比重：\(\Phi_{\text{split}} = \sum_i s_i \cdot \frac{x_i}{A_i}\)。

该结构既可通过大系数实现字典序优化，也可在求解器中分两阶段运行：先最小化 \(u+v\)（或限制在最优阈值以内），再在可行域内最小化偏好得分。

### 4. 基础约束
1. **可用票据范围**：
   \[
   y_i = 0 \quad \forall i \notin \mathcal{I}_{\text{limit}}
   \]
2. **金额与选择关系**：
   \[
   0 \le x_i \le A_i y_i,\quad x_i \ge A_i e_i - A_i (1-e_i),\quad y_i = e_i + s_i
   \]
   若不允许拆票（\(\text{allow\_split}=0\)），则强制 \(s_i = 0\)。
3. **付款单金额平衡**：
   \[
   \sum_{i} x_i - M = u - v, \quad u, v \ge 0
   \]
4. **票据数量限制**：
   \[
   \sum_i y_i \le N_{\max}
   \]
5. **小额票占比限制（启用时）**：设 \(\mathcal{I}_S\) 为小额票集合，约束 80% 张数对应金额至少覆盖 50% 付款金额，可线性化为：
   
   - 引入变量 \(t\) 表示按金额从大到小排序后第 \(\lceil 0.8 \sum_i y_i \rceil\) 张票的金额下界，通过排序辅助变量或使用扩展 formulation 实现；
   - 约束 \(\sum_{i \in \mathcal{I}_S} x_i \ge 0.5 M \) 与 \(\sum_{i \in \mathcal{I}_S} y_i \le 0.8 \sum_i y_i\) 的联合使用来逼近业务规则。

### 5. 拆票约束
在允许拆票的场景中，需要同时满足：
- 拆票金额与最小使用金额：
  \[
  x_i \ge \underline{a}^{\text{split}} s_i
  \]
- 拆票后剩余金额：
  \[
  A_i - x_i \ge \underline{r}^{\text{remain}} s_i
  \]
- 拆票比例：
  \[
  x_i \ge \underline{\theta}^{\text{ratio}} A_i s_i
  \]
- 尾差逻辑：
  \[
  u \le \overline{\delta}^{\text{amt}} + \overline{\delta}^{\text{ratio}} M + M (1 - r_{\text{tail}})
  \]
  \[
  r_{\text{tail}} = 1 \Rightarrow s_i = 0,\; \forall i \text{ 新增拆票}
  \]
  表示在尾差阈值内允许通过电汇补齐而不再拆票；若 \(r_{\text{tail}}=0\) 且 \(u>\overline{\delta}^{\text{amt}}\)，可触发对 \(s_i\) 的选择以补齐缺口。

拆票选票策略（远/近到期、不同承兑分类、金额接近差额等）可通过调整拆票候选集合或在 \(\Phi_{w_k}\) 中再次施加罚项实现。

### 6. 最高权重维度强制穿透
当启用强制穿透并设定权重维度 \(k\)（例如承兑人分类）时，需保证高优先级档位耗尽后才能使用下一档，可通过如下约束实现：
- 设档位集合为 \(\mathcal{R}_k\)，定义 \(\mathcal{I}_{k,r}\) 为处于档位 \(r\) 的票据集合，\(L_{k,r}\) 为“耗尽”判定阈值（可为库存张数或金额上限）。
- 引入二元变量 \(g_{k,r}\)，约束：
  \[
  \sum_{i \in \mathcal{I}_{k,r}} y_i \ge L_{k,r} g_{k,r}, \quad g_{k,r+1} \le g_{k,r}, \quad y_i \le g_{k,r} \; \forall i \in \mathcal{I}_{k,r+1}
  \]
这样只有当上一档位的 \(g_{k,r}=1\)（即认为已用尽）时，下一档位票据才允许被选中。

### 7. 输出与衍生指标
- 选票集合 \(\{i \mid y_i=1\}\) 及对应金额 \(x_i\)。
- 若 \(s_i=1\)，需记录拆票后新生成票据的金额、剩余金额、所属属性，用于更新库存。
- 实际金额差值 \(u, v\) 及尾差处理方式 \(r_{\text{tail}}\)。
- 偏好得分 \(\Phi_{w_k}\) 用于解释选票结果是否满足配置。

### 8. 模型求解建议
- 若要求实时（毫秒级）响应，可对 MIP 进行裁剪，先基于偏好做启发式筛选，再用 MIP 精调。
- 对于“金额策略”的不同子策略，可通过预排序或分支定界时的分支优先级实现；若求解器支持，可以在 Callback 中监控拆票逻辑。
- 对“优化期望库存占比”等软约束，可适当调节 \(\alpha_k\) 或转化为硬约束以保证可解释性。
