# 智能配票算法数学模型

## 1. 问题定义

智能配票问题是一个带有多维度偏好和复杂约束的组合优化问题，可以看作是多目标背包问题（Multi-Objective Knapsack Problem）的扩展变体。

## 2. 符号定义

### 2.1 基本符号

| 符号 | 说明 |
|------|------|
| $M$ | 付款单金额 |
| $N$ | 票据池中可用票据总数 |
| $n_{max}$ | 单张付款单允许使用的最大票据张数 |
| $\mathcal{T} = \{t_1, t_2, ..., t_N\}$ | 票据池，包含所有可用票据 |

### 2.2 票据属性

对于票据 $t_i \in \mathcal{T}$，定义以下属性：

| 属性符号 | 说明 |
|---------|------|
| $v_i$ | 票据 $t_i$ 的金额 |
| $d_i$ | 票据 $t_i$ 的到期天数 |
| $c_i$ | 票据 $t_i$ 的承兑人分类（1～n类） |
| $a_i$ | 票据 $t_i$ 的金额标签：$a_i \in \{\text{大额}, \text{中额}, \text{小额}\}$ |
| $o_i$ | 票据 $t_i$ 的承兑组织 |

### 2.3 金额标签定义

| 符号 | 说明 |
|------|------|
| $mp_1 = [l_1, u_1]$ | 大额票据金额范围 |
| $mp_2 = [l_2, u_2]$ | 中额票据金额范围 |
| $mp_3 = [l_3, u_3]$ | 小额票据金额范围 |
| $sp_1$ | 大额票据期望库存占比 |
| $sp_2$ | 中额票据期望库存占比 |
| $sp_3$ | 小额票据期望库存占比 |

其中，$sp_1 + sp_2 + sp_3 = 1$

### 2.4 决策变量

| 变量 | 说明 |
|------|------|
| $x_i \in \{0, 1\}$ | 二元决策变量，$x_i = 1$ 表示选择票据 $t_i$，否则为 0 |
| $\alpha_i \in [0, 1]$ | 票据 $t_i$ 的拆分比例，$\alpha_i = 1$ 表示使用整张票据 |
| $u_i = \alpha_i \cdot v_i$ | 票据 $t_i$ 的实际使用金额 |

## 3. 目标函数

### 3.1 主目标函数

$$
\max \quad S(\mathbf{x}, \boldsymbol{\alpha}) = \sum_{i=1}^{N} x_i \cdot \text{Score}_i(\boldsymbol{\alpha})
$$

其中，$\text{Score}_i(\boldsymbol{\alpha})$ 是票据 $t_i$ 的综合偏好得分。

### 3.2 综合偏好得分

综合偏好得分由四个维度的加权组合构成：

$$
\text{Score}_i = w_1 \cdot S_i^{(d)} + w_2 \cdot S_i^{(c)} + w_3 \cdot S_i^{(a)} + w_4 \cdot S_i^{(o)}
$$

其中：
- $w_1, w_2, w_3, w_4 \geq 0$ 且 $w_1 + w_2 + w_3 + w_4 = 1$（权重归一化约束）
- $S_i^{(d)}$：到期期限维度得分
- $S_i^{(c)}$：承兑人分类维度得分
- $S_i^{(a)}$：票据金额维度得分
- $S_i^{(o)}$：承兑组织维度得分

## 4. 维度得分计算

### 4.1 到期期限维度得分 $S_i^{(d)}$

设到期天数范围为 $[d_{min}, d_{max}]$，定义：

**策略1：优先远（天数阈值 $T_{far}$）**
$$
S_i^{(d)} = \begin{cases}
1 & \text{if } d_i \geq T_{far} \\
\frac{d_i - d_{min}}{T_{far} - d_{min}} & \text{if } d_{min} < d_i < T_{far} \\
0 & \text{if } d_i \leq d_{min}
\end{cases}
$$

**策略2：优先近（天数阈值 $T_{near}$）**
$$
S_i^{(d)} = \begin{cases}
1 & \text{if } d_i \leq T_{near} \\
\frac{d_{max} - d_i}{d_{max} - T_{near}} & \text{if } T_{near} < d_i < d_{max} \\
0 & \text{if } d_i \geq d_{max}
\end{cases}
$$

### 4.2 承兑人分类维度得分 $S_i^{(c)}$

设承兑人分类范围为 $\{1, 2, ..., n\}$，其中数字越小表示分类越好。

**策略1：优先承兑人分类好的**
$$
S_i^{(c)} = \frac{n + 1 - c_i}{n}
$$

**策略2：优先承兑人分类差的**
$$
S_i^{(c)} = \frac{c_i}{n}
$$

### 4.3 票据金额维度得分 $S_i^{(a)}$

#### 4.3.1 优化期望库存占比策略

设：
- $\mathcal{A} = \{\text{大额}, \text{中额}, \text{小额}\}$
- $\text{Expected}(k)$：金额标签 $k$ 的期望库存占比
- $\text{Current}(k)$：金额标签 $k$ 的当前实际库存占比

定义偏差：
$$
\Delta(k) = \max(0, \text{Current}(k) - \text{Expected}(k))
$$

归一化权重：
$$
W(k) = \frac{\Delta(k)}{\sum_{k' \in \mathcal{A}} \Delta(k')}
$$

则票据 $t_i$ 的金额维度得分：
$$
S_i^{(a)} = W(a_i)
$$

#### 4.3.2 大额优先策略

**子策略1：大额内从大到小**
$$
S_i^{(a)} = \begin{cases}
\frac{v_i - l_1}{u_1 - l_1} & \text{if } a_i = \text{大额} \\
0.5 & \text{if } a_i = \text{中额} \\
0.2 & \text{if } a_i = \text{小额}
\end{cases}
$$

**子策略2：大额内随机**
$$
S_i^{(a)} = \begin{cases}
\text{random}(0.7, 1.0) & \text{if } a_i = \text{大额} \\
0.5 & \text{if } a_i = \text{中额} \\
0.2 & \text{if } a_i = \text{小额}
\end{cases}
$$

#### 4.3.3 小额优先策略

**子策略1：小额内从小到大**
$$
S_i^{(a)} = \begin{cases}
0.2 & \text{if } a_i = \text{大额} \\
0.5 & \text{if } a_i = \text{中额} \\
\frac{u_3 - v_i}{u_3 - l_3} & \text{if } a_i = \text{小额}
\end{cases}
$$

**子策略2：小额内随机**
$$
S_i^{(a)} = \begin{cases}
0.2 & \text{if } a_i = \text{大额} \\
0.5 & \text{if } a_i = \text{中额} \\
\text{random}(0.7, 1.0) & \text{if } a_i = \text{小额}
\end{cases}
$$

#### 4.3.4 金额随机策略
$$
S_i^{(a)} = \text{random}(0, 1) \quad \forall i
$$

#### 4.3.5 整票金额小于等于付款单金额策略

对于组合 $\mathcal{S} = \{t_i : x_i = 1\}$，定义：
$$
\text{TotalAmount}(\mathcal{S}) = \sum_{i: x_i=1} u_i
$$

如果 $\text{TotalAmount}(\mathcal{S}) \leq M$，则组合得分加权：
$$
S_i^{(a)} = \begin{cases}
1 & \text{if } \text{TotalAmount}(\mathcal{S}) \leq M \\
0.5 & \text{otherwise}
\end{cases}
$$

#### 4.3.6 单票金额大于等于付款单金额策略
$$
S_i^{(a)} = \begin{cases}
1 & \text{if } v_i \geq M \\
0.2 & \text{otherwise}
\end{cases}
$$

### 4.4 承兑组织维度得分 $S_i^{(o)}$

设付款单的承兑组织为 $o_{\text{order}}$。

**策略1：优先匹配同组织**
$$
S_i^{(o)} = \begin{cases}
1 & \text{if } o_i = o_{\text{order}} \\
0 & \text{otherwise}
\end{cases}
$$

**策略2：优先匹配不同组织**
$$
S_i^{(o)} = \begin{cases}
0 & \text{if } o_i = o_{\text{order}} \\
1 & \text{otherwise}
\end{cases}
$$

## 5. 约束条件

### 5.1 基本约束

**票据数量约束：**
$$
\sum_{i=1}^{N} x_i \leq n_{max}
$$

**票据可用范围约束（到期期限）：**
$$
d_i \in D_{\text{allowed}} \quad \forall i: x_i = 1
$$

其中 $D_{\text{allowed}}$ 是允许的到期期限集合。

**票据可用范围约束（金额）：**
$$
v_i \in V_{\text{allowed}} \quad \forall i: x_i = 1
$$

其中 $V_{\text{allowed}}$ 是允许的金额范围。

**票据可用范围约束（承兑人分类）：**
$$
c_i \in C_{\text{allowed}} \quad \forall i: x_i = 1
$$

其中 $C_{\text{allowed}}$ 是允许的承兑人分类集合。

### 5.2 金额匹配约束

定义差额：
$$
\text{bias\_amount} = M - \sum_{i=1}^{N} x_i \cdot u_i
$$

**金额接近约束：**
$$
\left| M - \sum_{i=1}^{N} x_i \cdot u_i \right| \leq \epsilon
$$

其中 $\epsilon$ 是允许的金额偏差范围。

### 5.3 拆票约束

**拆票使能约束：**
$$
\alpha_i < 1 \Rightarrow \text{split\_allowed} = \text{True}
$$

**拆分后留存金额约束：**
$$
(1 - \alpha_i) \cdot v_i \geq R_{min} \quad \forall i: \alpha_i < 1
$$

其中 $R_{min}$ 是拆分后留存金额的最小值（默认5万）。

**拆分使用金额约束：**
$$
\alpha_i \cdot v_i \geq U_{min} \quad \forall i: \alpha_i < 1
$$

其中 $U_{min}$ 是拆分使用金额的最小值（默认5万）。

**拆分使用比例约束：**
$$
\alpha_i \geq P_{min} \quad \forall i: \alpha_i < 1
$$

其中 $P_{min}$ 是拆分使用金额占比的最小值（默认30%）。

### 5.4 小额票张数约束

设小额票集合为 $\mathcal{S}_{\text{small}} = \{t_i : a_i = \text{小额}, x_i = 1\}$。

如果存在小额票张数限制，则需满足：

将小额票按金额从小到大排序后，设前 $80\%$ 张数的小额票集合为 $\mathcal{S}_{\text{small}}^{80\%}$，则：
$$
\sum_{i \in \mathcal{S}_{\text{small}}^{80\%}} u_i \geq 0.5 \cdot M
$$

### 5.5 最高权重维度强制穿透约束

设最高权重维度为 $k^* = \arg\max_{k \in \{1,2,3,4\}} w_k$。

如果启用强制穿透，则：

**对于到期期限维度（$k^* = 1$）：**
$$
\forall i, j: x_i = 1, x_j = 1, \text{if } S_i^{(d)} > S_j^{(d)} \Rightarrow \text{必须先用完 } t_i \text{ 再用 } t_j
$$

**对于承兑人分类维度（$k^* = 2$）：**
$$
\forall i, j: x_i = 1, x_j = 1, \text{if } S_i^{(c)} > S_j^{(c)} \Rightarrow \text{必须先用完 } t_i \text{ 再用 } t_j
$$

类似地定义其他维度的强制穿透约束。

### 5.6 等额配票约束

如果启用"优先等额配票"，则添加约束：

定义等额票集合：
$$
\mathcal{T}_{\text{equal}} = \{t_i : |v_i - M| \leq \delta\}
$$

其中 $\delta$ 是等额判定阈值。

如果 $\mathcal{T}_{\text{equal}} \neq \emptyset$，则优先从该集合中选择：
$$
\exists i \in \mathcal{T}_{\text{equal}}: x_i = 1 \Rightarrow \sum_{i=1}^{N} x_i = 1
$$

## 6. 拆票策略模型

### 6.1 拆票触发条件

定义尾差阈值 $\text{tail\_diff}$，可以是：
- 绝对金额阈值：$T_{\text{abs}}$（默认1万）
- 占比阈值：$T_{\text{ratio}}$（默认30%）

**条件1：无限制拆分**

无额外条件。

**条件2：差额范围内无需拆分（电汇补齐）**

$$
\text{if } 0 < \text{bias\_amount} < \text{tail\_diff} \Rightarrow \text{不拆票，走电汇补齐}
$$

### 6.2 拆票选择策略

**场景1：差额大于0且大于尾差阈值（需补票）**

$$
\text{if } \text{bias\_amount} > 0 \text{ and } \text{bias\_amount} > \text{tail\_diff}
$$

从票据池 $\mathcal{T}$ 中选择一张新票 $t_j$ 进行拆分，选择依据：
$$
j^* = \arg\max_{j \in \mathcal{T} \setminus \mathcal{S}} S_j^{\text{(split)}}
$$

**场景2：差额小于0（超额需拆票）**

$$
\text{if } \text{bias\_amount} < 0
$$

从当前票据组合 $\mathcal{S}$ 中选择一张票 $t_i$ 进行拆分：
$$
i^* = \arg\max_{i \in \mathcal{S}} S_i^{\text{(split)}}
$$

### 6.3 拆票得分 $S_i^{\text{(split)}}$

拆票得分根据拆票策略 $\text{split\_strategy}$ 计算，可以基于以下维度：

**按到期期限维度：**
$$
S_i^{\text{(split)}} = S_i^{(d)}
$$

**按承兑人分类维度：**
$$
S_i^{\text{(split)}} = S_i^{(c)}
$$

**按金额维度 - 大额优先：**
$$
S_i^{\text{(split)}} = \frac{v_i}{\max_j v_j}
$$

**按金额维度 - 接近大于差额：**
$$
S_i^{\text{(split)}} = \begin{cases}
\frac{1}{v_i - |\text{bias\_amount}|} & \text{if } v_i \geq |\text{bias\_amount}| \\
0 & \text{otherwise}
\end{cases}
$$

### 6.4 拆分比例计算

对于选定的待拆票据 $t_{j^*}$，计算最优拆分比例：

**场景1（补票）：**
$$
\alpha_{j^*} = \min\left(1, \frac{\text{bias\_amount}}{v_{j^*}}\right)
$$

需满足拆票约束：
$$
\alpha_{j^*} \geq P_{min}, \quad \alpha_{j^*} \cdot v_{j^*} \geq U_{min}, \quad (1 - \alpha_{j^*}) \cdot v_{j^*} \geq R_{min}
$$

**场景2（超额拆票）：**
$$
\alpha_{i^*} = \max\left(P_{min}, \frac{M - \sum_{j \neq i^*, x_j=1} u_j}{v_{i^*}}\right)
$$

需满足拆票约束。

## 7. 优化问题完整表述

### 7.1 标准形式

$$
\begin{aligned}
\max \quad & S(\mathbf{x}, \boldsymbol{\alpha}) = \sum_{i=1}^{N} x_i \cdot \left( w_1 S_i^{(d)} + w_2 S_i^{(c)} + w_3 S_i^{(a)} + w_4 S_i^{(o)} \right) \\
\text{s.t.} \quad & \sum_{i=1}^{N} x_i \leq n_{max} \\
& x_i \in \{0, 1\}, \quad i = 1, 2, ..., N \\
& 0 < \alpha_i \leq 1, \quad i = 1, 2, ..., N \\
& w_1 + w_2 + w_3 + w_4 = 1, \quad w_k \geq 0, \quad k = 1, 2, 3, 4 \\
& \left| M - \sum_{i=1}^{N} x_i \alpha_i v_i \right| \leq \epsilon \\
& \alpha_i < 1 \Rightarrow \begin{cases}
(1 - \alpha_i) v_i \geq R_{min} \\
\alpha_i v_i \geq U_{min} \\
\alpha_i \geq P_{min}
\end{cases} \\
& \text{其他业务约束}
\end{aligned}
$$

### 7.2 问题复杂度分析

该优化问题具有以下特点：

1. **NP-难问题**：本质上是多维背包问题的扩展，属于NP-Hard问题
2. **混合整数非线性规划（MINLP）**：包含离散变量（$x_i$）和连续变量（$\alpha_i$）
3. **多目标优化**：通过加权方式转化为单目标优化
4. **动态约束**：某些约束（如拆票约束）只在特定条件下激活

### 7.3 求解方法建议

针对该问题的特点，推荐以下求解方法：

1. **启发式算法**：
   - 贪心算法（快速得到可行解）
   - 遗传算法（全局搜索）
   - 模拟退火（跳出局部最优）

2. **分阶段求解**：
   - 第一阶段：基于偏好得分进行票据排序
   - 第二阶段：顺序选择票据直到满足金额要求
   - 第三阶段：根据差额进行拆票或微调

3. **动态规划**：
   - 适用于票据数量较少的情况
   - 状态：已选票据集合和当前总金额
   - 转移：选择或不选择下一张票据

## 8. 输出结果结构

优化问题的解包含以下信息：

| 输出项 | 符号表示 | 说明 |
|--------|---------|------|
| 选中票据列表 | $\{t_i : x_i = 1\}$ | 被选中的票据集合 |
| 各票据使用金额 | $\{u_i = \alpha_i v_i : x_i = 1\}$ | 每张票据的实际使用金额 |
| 各票据拆分比例 | $\{\alpha_i : x_i = 1\}$ | 每张票据的拆分比例（1表示整票使用） |
| 总使用金额 | $\sum_{i: x_i=1} u_i$ | 所有选中票据的使用金额之和 |
| 差额 | $\text{bias\_amount} = M - \sum_{i: x_i=1} u_i$ | 与付款单金额的差额 |
| 票据数量 | $\sum_{i=1}^{N} x_i$ | 使用的票据张数 |
| 综合得分 | $S(\mathbf{x}, \boldsymbol{\alpha})$ | 该方案的综合偏好得分 |
| 各维度得分 | $(S^{(d)}, S^{(c)}, S^{(a)}, S^{(o)})$ | 各维度的分项得分 |

## 9. 模型扩展

### 9.1 多付款单批量配票

对于多个付款单 $\{M_1, M_2, ..., M_K\}$，目标函数扩展为：

$$
\max \sum_{k=1}^{K} S_k(\mathbf{x}^{(k)}, \boldsymbol{\alpha}^{(k)})
$$

约束条件增加：
$$
\sum_{k=1}^{K} x_i^{(k)} \leq 1 \quad \forall i \quad \text{（每张票最多使用一次）}
$$

### 9.2 考虑时间因素的动态配票

引入时间维度 $t$，票据的偏好得分随时间变化：

$$
S_i(t) = f(d_i - t, c_i, v_i, o_i)
$$

随着时间推移，到期天数减少，需要动态更新偏好得分。

### 9.3 风险因素建模

引入风险系数 $r_i \in [0, 1]$，表示票据 $t_i$ 的风险水平，修改目标函数：

$$
\max \sum_{i=1}^{N} x_i \cdot (1 - r_i) \cdot \text{Score}_i
$$

## 10. 总结

本数学模型将智能配票业务问题形式化为一个带有多维度偏好得分的混合整数非线性优化问题。模型的核心包括：

1. **决策变量**：票据选择（二元变量）和拆分比例（连续变量）
2. **目标函数**：最大化基于四个维度（到期期限、承兑人分类、票据金额、承兑组织）加权的综合偏好得分
3. **约束条件**：票据数量限制、金额匹配要求、拆票规则、业务规则等多层次约束
4. **拆票策略**：根据差额情况动态决定是否拆票、拆哪张票、拆分比例

该模型为算法实现提供了清晰的数学基础，可以根据具体业务需求调整权重、阈值和策略参数。
