# 智能配票算法流程设计

## 1. 设计目标

在统一票据池中，根据付款单的金额需求、业务偏好与约束配置，自动生成最优票据组合方案，使票据使用金额尽可能贴近付款单金额，并兼顾优先级、拆票规则与库存结构。本设计文档给出系统化的流程拆解与代码映射，便于工程实现与后续扩展。

## 2. 输入输出定义

### 2.1 输入

| 输入项 | 说明 |
| --- | --- |
| 付款单列表 | 每条付款单包含唯一标识、金额、所属组织、个性化偏好/约束等配置 |
| 票据池 | 全部可用票据的集合，每张票据包含金额、到期天数、承兑人分类、金额标签、承兑组织等属性 |
| 权重与偏好配置 | 四个维度（到期期限、承兑人分类、金额策略、承兑组织）的权重值及具体策略参数 |
| 拆票规则配置 | 是否允许拆票、尾差阈值（金额/比例）、拆分选票策略、拆分后留存金额等参数 |
| 数量与标签约束 | 单张付款单最大用票张数、小额票张数限制、库存占比目标等 |

### 2.2 输出

| 输出项 | 说明 |
| --- | --- |
| 选中票据列表 | 每张票据的使用金额、拆分比例、对应得分及参与顺序 |
| 综合统计 | 组合总金额、与付款单金额的差额、综合偏好得分、使用张数 |
| 约束状态 | 各项约束与拆票规则的满足情况，包含告警或调节记录 |
| 副作用数据 | 更新后的票据池余量信息，为后续付款单继续分配提供依据 |

## 3. 流程总览

整体流程由七个阶段组成：

1. **配置解析与初始化**：合并全局配置与付款单私有配置，生成当前订单的运行上下文。
2. **票据预处理**：按照到期、金额、承兑分类等硬性条件过滤票据池，得到候选集合。
3. **优先等额尝试**：若启用“等额配票”，先在候选集合中搜索金额与付款单接近的整票并择优选取。
4. **偏好得分计算**：对剩余候选票据逐一计算四维度偏好得分并汇总成综合得分，同时打标辅助信息（如分层级）。
5. **组合构建**：基于综合得分、最高权重维度与数量约束，采用启发式策略构建票据组合；必要时执行局部替换或回退优化。
6. **拆票调节**：当组合金额与付款单存在非允许尾差时，按拆票策略执行补票或拆分，并校验拆票约束。
7. **结果封装与池更新**：输出最终方案，更新票据池，把使用金额从可用库存中扣减，继续处理下一个付款单。

下图给出抽象流程（文字描述）：

```
开始 → 载入配置 → 过滤票据池 → 等额候选？→(是) 直接择优 →(否) 评分排序 → 组合构建 → 差额判定 →(尾差可接受) 输出方案 →(尾差不可接受) 拆票调节 → 约束复核 → 结果输出 & 更新票池 → 结束
```

## 4. 核心阶段说明

### 4.1 配置解析
- 合并默认配置与订单自定义配置，得到运行上下文 `AllocationContext`。
- 解析最高权重维度及其参数，为“强制穿透”约束做准备。

### 4.2 票据预处理
- 过滤掉到期区间外、金额范围外、承兑人分类不在允许范围内的票据。
- 若存在库存分布策略，提前统计当前票池的金额标签分布，用于后续得分计算。

### 4.3 偏好得分计算
- **到期期限**：根据策略（优先远/优先近）和阈值，使用线性或分段函数赋分。
- **承兑人分类**：按“优先好/优先差”转换为归一化分值。
- **金额策略**：支持“大额优先”“小额优先”“随机”“优化库存占比”“整票≤订单金额”“单票≥订单金额”等多种模式。
- **承兑组织**：匹配付款单组织或反向匹配。
- 综合得分 = 各维度得分 × 权重之和，保留维度明细以便解释。

### 4.4 组合构建策略
- 若配置启用等额优先且存在候选整票，按综合得分择优并直接返回。
- 否则采用分层贪心：先按最高权重维度分层，再在层内依据综合得分从高到低挑选。
- 添加票据时校验：
  - 最大张数约束
  - 小额票张数与金额覆盖约束
  - 强制穿透：下一个层级只有在上一层级票用尽时才能使用。
- 若组合未覆盖金额，尝试从剩余候选中补票或执行局部替换。

### 4.5 拆票调节
- 计算差额 `bias_amount = M - 已用金额`。
- 判断尾差：若在阈值内且允许电汇补齐，则保留差额结果；否则进入拆票流程。
- 补票场景（差额>尾差阈值）：
  - 从未使用票据中根据拆票策略（到期/承兑分类/金额）选择拆分对象。
  - 计算拆分比例并校验最小留存、最小使用金额、占比限制。
- 超额场景（差额<0）：从组合中选择拆分票据，减少使用金额，满足约束。

### 4.6 结果封装
- 输出选中票据的使用金额、拆分比例、维度得分、入选顺序。
- 汇总组合总金额、综合偏好得分、差额、触发的调节记录。
- 将票据使用金额同步回票据池，供下一付款单继续使用。

## 5. 小额票约束处理
- 对被选中的小额票据按金额升序排序，统计前 80% 张数的金额覆盖度。
- 若覆盖度未达到配置阈值（默认 50%），则尝试：
  1. 提升高金额小票或替换部分小票；
  2. 若仍无法满足，输出告警并标记方案为部分不合规，等待人工介入。

## 6. 多付款单批处理
- 付款单按优先级排序（可按到期日、金额大小或外部指定）。
- 针对每个付款单执行完整流程，使用后的票据金额即时从票据池扣减。
- 支持在批处理过程中记录票池快照，以便追踪使用轨迹。

## 7. 模块划分与代码映射

| 模块 | 说明 | 主要方法 |
| --- | --- | --- |
| `models` | 数据结构定义（票据、付款单、结果、配置） | 数据类、枚举 |
| `scoring` | 四维度偏好得分计算 | `score_ticket`、`score_collection` |
| `constraints` | 数量与标签约束校验 | `validate_max_count`、`validate_small_ticket` |
| `splitter` | 拆票策略实现 | `adjust_positive_bias`、`adjust_negative_bias` |
| `engine` | 核心流程编排 | `allocate`、`allocate_batch` |

在代码实现中，这些模块被整合在 `src/allocation_engine.py` 中，以便快速落地；后续可根据需要拆分为独立文件。

## 8. 扩展与优化建议
- 引入更强的组合优化算法（如整数规划、遗传算法）替换贪心策略。
- 增加策略 A/B 测试与在线学习模块，动态调整权重与阈值。
- 建立调度日志与回放工具，复现配票过程便于审计。
- 将拆票策略与外部定价系统联动，评估拆票带来的成本收益。
