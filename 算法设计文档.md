# 智能配票算法设计文档

## 1. 业务背景与问题建模
智能配票业务的核心是：针对单笔付款单，在规模 7000~10000 张的票据池中，挑选一组票据（可包含拆分部分）使得组合金额与付款单金额 \(M\) 尽量贴合，同时满足多维度的业务偏好与强制约束。这一问题可抽象为多目标组合优化：
- **不可拆分场景**等价于带偏好的 0/1 背包问题；
- **允许拆分场景**扩展为部分背包模型，并需在拆分前后校验尾差、留存和拆分金额等规则。

算法需要兼顾金额匹配精度、到期时间偏好、承兑人评级、组织归属、库存平衡等要求，并在秒级内给出高质量方案以及拆票、电汇尾差与剩余库存等辅助信息。

## 2. 输入与数据描述
### 2.1 单付款单参数
| 参数 | 说明 |
|------|------|
| `M` | 付款单金额（元） |
| `pay_organization` | 付款单所属组织 |

### 2.2 票据池结构
- 票据池规模：\(N = 7000\sim 10000\)。
- 每张票据 \(i\) 包含属性：
  | 属性 | 说明 |
  |------|------|
  | `A_i` | 票面金额（元，保留两位小数） |
  | `A_{C_i}` | 金额区间类别（大票/中票/小票） |
  | `D_i` | 距离到期日的天数（正整数） |
  | `C_i` | 承兑人分类（1~8 或映射评分，数值越小代表质量越好） |
  | `ticket_organization` | 票据所属组织 |

- 票据池整体统计：
  - 各金额类别占比：`p_c_big`、`p_c_middle`、`p_c_small`，且三者之和为 1；
  - 各类别张数：`n_c_big`、`n_c_middle`、`n_c_small`。

### 2.3 可用范围过滤
用户可对候选票据设置硬过滤条件（任一未满足则剔除）：
- **到期期限**：支持按月份或天数设定阈值（如“≥3 个月”、“>30 天”）；
- **票面金额**：可限定金额区间（如“≥100 万”、“当月票”）；
- **承兑人分类**：指定可接受的分类集合（1~8 任意子集）。

### 2.4 票据标签与配置
- `amount_dist`：自定义金额区间划分，示例 `{ "大额": [min, max], "中额": ..., "小额": ... }`；
- `remain_dist`：配票后期望剩余库存区间，例如 `{ "大额": e_p_c_big, "中额": e_p_c_middle, "小额": e_p_c_small }`，用于库存平衡偏好。

### 2.5 用户偏好参数
| 参数 | 说明 |
|------|------|
| `prefer_exact` | 是否优先匹配等额票；若存在多张等额票，再依据权重排序择优选择 |
| `allow_split` | 是否允许拆票 |
| `force_top_priority` | 最高权重维度是否需要穿透执行（强制在该维度按优先级用尽后再使用次级资源） |

## 3. 权重维度与策略配置
用户通过权重 `w1 + w2 + w3 + w4 = 1` 控制各偏好维度的重要性。

### 3.1 金额策略（`w1` 对应）
可选策略与子策略：
1. **大额优先**：
   - 子策略：大额区间内随机；或按金额从大到小排序。
2. **小额优先**：
   - 子策略：小额区间内随机；或按金额从小到大排序。
3. **金额随机**：候选票据按均匀概率采样。
4. **接近但小于 M**：优先选择总额不超过 \(M\) 的组合；尾差默认通过电汇补齐（不拆票）。
5. **接近但大于 M**：允许总金额略高于 \(M\)，通过拆票削减差额。
6. **优化期望库存占比**：根据当前库存 `p_c_*` 与期望余票 `remain_dist`，计算类别偏差并转化为优先耗用顺序与动态权重。例如：
   \[
   score_{class} \propto (p_c^{init} - remain_dist)_{class}
   \]
   偏差越大的类别得分越高，优先被选用。

### 3.2 期限策略（`w2` 对应）
- **优先远期**：当 `D_i` 大于阈值 `T_far` 时得分更高；
- **优先近期**：当 `D_i` 小于阈值 `T_near` 时得分更高。

### 3.3 承兑人策略（`w3` 对应）
- **优先差**：按承兑人评分由大到小排序（或映射分值由低到高地惩罚优质票）；
- **优先好**：按评分值由小到大排序。

### 3.4 组织策略（`w4` 对应）
- **本组织优先**：优先匹配 `ticket_organization == pay_organization` 的票据；
- **外组织优先**：优先使用 `ticket_organization != pay_organization` 的票据。

### 3.5 综合打分函数
综合得分采用加权求和：
\[
F(i) = w_1 f_{amount}(i) + w_2 f_{term}(i) + w_3 f_{acceptor}(i) + w_4 f_{organization}(i)
\]
若启用库存余票目标，可额外叠加库存惩罚项 `f_{inventory}`。评分函数用于候选票排序、方案评价及局部优化决策。

## 4. 约束体系
1. **金额贴合与尾差**：
   - 组合金额 `Σ y_i` 应接近 `M`，偏差 \(|bias\_amount| = |M - Σ y_i|\) 需小于尾差阈值 `tail_diff`（金额阈值或占比阈值）。
   - 若不允许拆票且 `bias_amount > tail_diff`，需回退组合；允许拆票时可触发拆票策略。
2. **票据张数限制**：单笔付款单可用票据张数不得超过配置上限 `S_max`；若允许浮动，可在阈值附近放宽。
3. **小票约束**：如启用，按照金额从小到大排序，前 80% 张数的累计金额需覆盖付款单金额的至少 50%。
4. **拆票约束**（仅 `allow_split = true` 时）：
   - 拆后留存金额 `s_i` ≥ 留存下限（默认 5 万）；
   - 拆分使用金额 `y_i` ≥ 使用下限（默认 5 万或占比 ≥ 30%）；
   - 若拆分后留存不达标，可尝试其他票据或回退。
5. **拆分条件**：
   - 当 `bias_amount > 0` 且 `bias_amount > tail_diff` 时，从票据池选择一张新票拆分；
   - 当 `bias_amount < 0` 时，在当前组合中选择票据拆分；
   - 当 `0 < bias_amount < tail_diff` 可选择电汇尾差，避免拆票。

## 5. 拆票策略设计
### 5.1 拆票触发与流程
- **正差额（低于 M）**：
  1. 根据拆票策略筛选候选票（金额、期限、承兑人偏好同评分维度）。
  2. 选择一张票拆出金额 `y_split` ≈ `bias_amount`。
  3. 校验拆分后留存金额是否合规；不通过则尝试下一张。
- **负差额（超过 M）**：
  1. 在当前组合中寻找可拆分票，拆出金额 `abs(bias_amount)`。
  2. 校验拆分占比与留存规则；不满足则换票或回退。
- **重试与降级**：拆票失败超过上限次数后，回退到上一策略级别，允许走电汇尾差或重新组合。

### 5.2 拆票策略类别
- **金额维度**：大额优先 / 接近差额优先；
- **期限、承兑人**：直接复用全局权重策略，确保偏好一致；
- **库存导向（可选）**：优先拆分偏差最大的类别票据，以优化余票结构。

## 6. 算法流程设计
整体采用“预筛选 + 分阶段构造 + 局部优化”的启发式框架，既保证响应速度，又易于解释。

### Step0：参数解析与预处理
- 解析用户配置（权重、策略、阈值等），构建统一参数对象；
- 根据 `force_top_priority` 确定硬排序维度；
- 初始化票据评分函数和库存统计。

### Step1：候选集过滤 `fast_prefilter`
1. 按可用范围（期限、金额、承兑人）做硬过滤，形成候选集合 `I_M`；
2. 计算每张票的维度得分 `f_*` 与综合得分 `F(i)`；
3. 保留前 `K` 张高分票（通常 500~1000），并在 `prefer_exact=true` 时额外保留所有等额票；
4. 若金额策略要求（如“接近小于 M”），在过滤阶段预先剔除不满足的票。

### Step2：分层贪心构造 `improved_greedy_construct`
- 根据 `F(i)` 对候选票排序，并结合最高权重维度做分层；
- 采用“严格→适度→宽松”三轮遍历：
  1. 严格轮：仅接受满足强约束（金额不超、张数未满、拆票不得触发）的票；
  2. 适度轮：允许临界尾差或潜在拆票；
  3. 宽松轮：当已无合适票时，可放宽至库存或组织策略。
- 每加入一张票即更新组合金额、张数、偏好得分和库存统计；若导致强约束违规则回退。

### Step3：局部优化阶段
1. **拆票优化 `_optimize_split`**：按第 5 节规则处理 `bias_amount`；
2. **交换优化 `_swap_optimization`**：尝试用未使用的高分票替换组合内低分票，前提是金额偏差与约束得以保持或改善；
3. **库存微调 `_balance_inventory`（可选）**：根据剩余库存与 `remain_dist` 的偏差进行小范围调换或拆分，降低库存惩罚。

### Step4：尾差与结果收敛
- 若尾差在阈值内且约束均满足，则停止；
- 若尾差仍超标且拆票失败，判定方案不可行，触发回溯或降级策略（如转为电汇尾差）。

## 7. 输出结构与说明
最终输出包括：
1. **配票配置**：记录权重、策略、尾差阈值、拆票规则等；
2. **选中票据组合**：列表元素形如 `(ticket_id, 票面金额, 使用金额, 留存金额, 是否拆分)`；
3. **票据结构分布**：大/中/小票数量及占比；
4. **组合得分**：总分及各维度子得分；
5. **金额信息**：组合金额、目标金额、电汇尾差、拆票金额、留存金额；
6. **过程指标**：配票耗时、迭代次数、回退/拆票尝试次数等；
7. **余票库存分布**：用于评估库存是否达成目标。

## 8. 性能与复杂度分析
- 预筛选阶段以排序为主，复杂度约 `O(N log N)`；
- 贪心构造在限定候选集后近似 `O(K)`（K 通常 <1000），三轮遍历保证几毫秒级；
- 拆票与交换优化限定在数量有限的候选子集，控制迭代次数（≤50 次）后可确保总耗时在秒级以内；
- 算法保持良好可解释性，便于审计与人工干预。

## 9. 扩展与落地建议
1. **策略扩充**：可引入承兑人黑白名单、供应商评级、票源渠道等更多偏好维度，通过调整权重或增加惩罚函数实现；
2. **精细化优化**：对于金额敏感场景，可将该启发式方案作为初始解，结合整数规划、局部搜索（模拟退火、禁忌搜索等）提升精度；
3. **自适应调参**：基于历史数据训练排序或加权模型（Learning to Rank/强化学习），自动调整策略权重；
4. **并行与缓存**：在高并发场景，将预筛和评分阶段拆分为多线程/多进程处理，或对频繁出现的票据特征做缓存加速；
5. **可解释性增强**：记录各阶段的得分变化、约束检查、拆票过程，用于生成配票日志和审计报告。

## 10. 总结
本文档在《智能配票算法逻辑》基础上，明确输入要素、用户偏好、权重策略、约束体系与拆票规则，设计出以“预筛选→贪心构造→局部优化”为主线的整体算法框架。该框架既满足业务对金额贴合与偏好控制的要求，又保留策略扩展与性能优化空间，可为后续实现与迭代提供系统化指引。
