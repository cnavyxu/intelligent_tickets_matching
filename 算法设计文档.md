# 智能配票算法设计文档

## 1. 背景与目标
智能配票问题来源于票据撮合业务：针对单笔付款单，需要从规模为 7k~10k 的票据池中挑选出满足多维偏好与约束条件的票据组合，使得组合金额在既定误差范围内逼近付款单金额。业务既要求金额匹配精度，又需兼顾到期时间、承兑人评级、组织归属以及库存结构等定性偏好，因此该问题可抽象为带多目标权重与软硬约束的组合优化模型。

根据是否允许拆分票据，该问题可以映射为两类经典模型：
- **不可拆分**：复杂偏好约束下的 0/1 背包问题；
- **可拆分**：在部分背包（Fractional Knapsack）基础上的扩展模型，需要在拆票前后校验多项业务规则。

最终目标是构造一个得分最高、金额最贴合的票据组合，并给出配票过程产生的拆票、电汇尾差以及余票库存分布等信息，以支撑业务审批与后续清分。

## 2. 符号体系
| 符号/变量 | 含义 |
|-----------|------|
| `I` | 票据池索引全集 |
| `I_M` | 预筛选后保留的候选票集合 |
| `M` | 付款单金额（元） |
| `A_i` | 票据 i 原始票面金额 |
| `A_i^{cat}` | 票据 i 所属金额区间类别（大/中/小） |
| `D_i` | 票据 i 距离到期的天数 |
| `C_i` | 票据 i 承兑人评分或等级映射值 |
| `O_i` | 票据 i 所属组织 |
| `org_p` | 付款单所属组织 |
| `w_1, w_2, w_3, w_4` | 四个偏好维度权重，和为 1 |
| `tail` | 尾差阈值（金额上限或占比） |
| `S_{max}` | 单笔付款单允许的票据张数上限 |
| `A_{min}, A_{max}` | 单票使用金额上下界 |
| `N_{min}` | 极小金额票据允许数量上限 |
| `pc^{init}` | 初始库存类型占比（大/中/小） |
| `ec^{target}` | 用户期望的库存余票占比 |

### 2.1 用户偏好与控制参数
- `prefer_exact`：是否优先选择等额票；
- `allow_split`：是否允许拆票；
- `allow_inventory_balance`：是否启用库存平衡偏好；
- `amount_dist`：金额区间划分（大/中/小票）；
- `remain_dist`：目标余票区间配置；
- 拆票规则参数：尾差阈值、拆后留存阈值、最小拆分金额、拆分占比下限等。

## 3. 决策变量
| 变量 | 含义 |
|------|------|
| `x_i ∈ {0,1}` | 票据 i 是否被纳入组合 |
| `y_i ≥ 0` | 票据 i 实际使用金额；若未选取则为 0 |
| `s_i ≥ 0` | 票据 i 拆分后的留存金额；未拆分则为 0 |
| `z_split` | 是否触发拆票的逻辑指示（实现层面用条件判断） |

## 4. 约束设计
1. **金额贴合与张数限制**  
   - `Σ_i y_i ≤ M + tail`  
   - `Σ_i y_i ≥ M − tail`（不可拆分模式下用作停止条件）  
   - `Σ_i 1[y_i > 0] ≤ S_{max}`
2. **单票使用金额范围**  
   - 若票据被选用，则需满足 `A_{min} ≤ y_i ≤ min(A_{max}, A_i)`
3. **拆票留存约束（允许拆票时生效）**  
   - `s_i = A_i − y_i`；  
   - `s_i = 0` 或 `s_i ≥ remain_after_split`；
   - 拆分金额需满足 5 万起或占比下限等业务规定。
4. **极小金额票据约束**  
   - `Σ_i 1[y_i < 2·A_{min}] ≤ N_{min}`。
5. **库存平衡（软约束）**  
   - 拆票后库存占比 `pc^{remaining}` 与目标 `ec^{target}` 的偏差需低于阈值 `ε_c`。实际实现为评分惩罚。
6. **组织、期限、承兑人偏好**  
   - 在筛选与排序阶段体现为强制条件或加权评分。

## 5. 目标函数
综合采用加权评分模型：
\[
\max \big( w_1·f_{amount} + w_2·f_{term} + w_3·f_{acceptor} + w_4·f_{organization} + w_{inv}·f_{inventory} \big)
\]
其中 `w_{inv}` 在启用库存平衡时默认为 0.2，否则为 0。各评分项定义如下：
- `f_{amount}`：金额策略评分，支持“大额优先”“小额优先”“随机”“接近但小于/大于 M”“库存优化”等模式；
- `f_{term}`：期限评分，依据“优先远/优先近”对距离到期天数归一化；
- `f_{acceptor}`：承兑人评分，按优先好/差映射为升序或降序分值；
- `f_{organization}`：组织评分，强化同组织或跨组织偏好；
- `f_{inventory}`：库存匹配评分，依据剩余库存与期望占比的偏差计算。

目标函数在贪心构造与局部优化阶段被多次调用，用于指导票据排序及方案优劣判定。

## 6. 算法总体流程
整体流程采用“预筛选 + 贪心构造 + 局部优化”的分层启发式策略，保证秒级响应能力并兼顾业务可解释性。

```text
              ┌─────────────────────────┐
              │       输入参数集        │
              └──────────┬──────────────┘
                         │
            ┌────────────▼────────────┐
            │ Step1: 快速预筛 (_fast_) │
            └────────────┬────────────┘
                         │
            ┌────────────▼────────────┐
            │ Step2: 改进贪心构造      │
            │ (_improved_greedy_)     │
            └────────────┬────────────┘
                         │
            ┌────────────▼────────────┐
            │ Step3: 局部优化阶段      │
            │  - 拆票优化             │
            │  - 交换优化             │
            │  - 库存微调             │
            └────────────┬────────────┘
                         │
               ┌─────────▼───────────┐
               │    输出配票结果      │
               └─────────────────────┘
```

### 6.1 快速预筛选 `_fast_prefilter`
- 依据金额上下界和金额策略对子集进行裁剪；
- 依据权重配置综合打分，保留最高分的前若干百票据；
- 可追加强制过滤（如尾差、电汇规则）。

### 6.2 改进贪心构造 `_improved_greedy_construct`
- 按综合得分对候选票排序；
- 通过“严格→适度→宽松”三轮试探加入票据，逐步放宽金额误差并控制张数；
- 实时检测金额越界与极小票数量，必要时回退或跳过票据；
- 若存在 `prefer_exact`，先尝试等额票并与权重最高的维度排序结合。

### 6.3 局部优化阶段
1. **拆票优化 `_optimize_split`**  
   - 当差额 `bias = M − Σ y_i` 超过尾差阈值时，触发拆分策略；
   - 正差额：从未使用票据中选择合适票拆分（遵循金额/期限/承兑人偏好）；
   - 负差额：在当前组合中选择票拆分，保证留存金额合法；
   - 拆票失败则回溯至上一级策略或选择电汇尾差。
2. **交换优化 `_swap_optimization`**  
   - 在允许的金额偏差范围内尝试用未使用的高分票替换已选低分票；
   - 每次交换后重新计算总金额与综合得分，确保改进；
   - 控制迭代次数，避免过度计算。
3. **库存微调 `_balance_inventory`（可选）**  
   - 根据剩余库存与目标占比的偏差进行微调；
   - 对组合进行局部调整以降低库存差距评分。

## 7. 拆票策略与规则
拆票策略遵循以下原则：
1. **触发条件**：
   - `bias > 0` 且 `bias > tail`：需从候选票中拆分；
   - `bias < 0`：从当前组合拆分，重新分配金额；
   - `0 < bias < tail`：可选择电汇补齐，避免拆分。
2. **选票策略**：
   - 金额维度：支持“大额优先”或“接近差额优先”；
   - 期限与承兑人维度：复用权重配置排序；
   - 拆分优先考虑满足留存阈值与拆分金额下限的票据。
3. **约束校验**：
   - 拆后留存金额≥设定阈值，如 5 万；
   - 拆分金额≥最小使用金额或比例；
   - 拆票次数与失败重试次数受限，避免无限循环。
4. **回退机制**：
   - 若拆分后仍不满足金额区间，则回退并尝试下一票；
   - 连续失败后降级为电汇尾差或保留原组合。

## 8. 结果输出结构
配票完成后输出以下信息：
- 配票配置：权重、策略、尾差阈值、库存目标等；
- 选中的票据组合明细 `[(票据ID, 票据金额, 使用金额, 留存金额, 是否拆分)]`；
- 票据结构分布（大/中/小票数量及占比）；
- 组合综合得分与各维度子得分；
- 总组合金额与目标付款单金额；
- 电汇尾差金额（如有）；
- 拆票金额与留存金额统计（如有）；
- 配票耗时与迭代次数；
- 余票库存分布（用于库存平衡评估）。

## 9. 复杂度与性能
- 预筛选以排序为主，复杂度约 `O(N log N)`；
- 贪心构造最多遍历 1000 张候选票三轮，约 `O(3·10^3)`；
- 拆票与交换优化限定在局部候选集，迭代次数设为 50，整体控制在毫秒级；
- 对 7k~10k 规模的票据池，可保证秒级响应能力，满足在线配票需求。

## 10. 可扩展性与后续优化建议
1. **策略扩展**：新增承兑人黑白名单、票据供应商等级等偏好因子，可通过增设权重维度或引入惩罚函数实现。
2. **精确优化**：在高价值场景下，可将贪心结果作为初始解，调用整数规划或局部搜索算法（如 Simulated Annealing、Tabu Search）进一步提升贴合度。
3. **学习化调参**：结合历史配票数据，通过学习模型（如 Learning to Rank）自动调节权重与评分函数参数，实现自适应优化。
4. **并行化预筛**：在高并发场景，可对金额区间、组织分类进行并行筛选，提高吞吐能力。
5. **可解释性增强**：记录每一步决策的依据（得分、约束检查结果），以报表形式输出，提升审核透明度。

## 11. 实现映射（参考现有代码）
> 以下结构参考 `optimized_ticket_matcher.py` 中既有实现，便于新改造或重构：

- 数据结构：`Ticket`、`PaymentOrder`、`UserPreference`、`TargetWeights`、`SplitRule`、`Constraints`、`InventoryInfo`、`Solution`、`TicketUsageDetail`；
- 核心流程入口：`OptimizedTicketMatcher.optimize()`；
- 关键子函数：
  - `_fast_prefilter`：预筛选；
  - `_improved_greedy_construct`：贪心构造；
  - `_optimize_split`、`_split_from_pool`、`_split_from_current`：拆票逻辑；
  - `_swap_optimization`：局部交换；
  - `_balance_inventory`：库存平衡；
  - `_compute_scores`、`_calc_solution_score`：维度评分与总分计算。
- 测试/示例：`run_example`、`test_correct_split.py`、`test_split_fix.py`、`test_split_output.py` 覆盖典型场景。

## 12. 总结
本文档在充分阅读现有《智能配票算法逻辑》及《智能配票优化建模设计文档》的基础上，对智能配票问题的业务背景、模型抽象、约束体系、目标函数、实现流程及性能表现进行了系统梳理。整体算法采用多目标加权评分与多阶段启发式优化相结合的策略，兼顾金额贴合度、用户偏好和库存平衡等核心诉求，可为后续的迭代开发与算法调优提供统一框架和可执行指引。
