# 文档与代码同步更新总结

## 更新日期
2024年（基于【智能配票算法逻辑.md】的最新内容）

## 更新背景
根据【智能配票算法逻辑.md】中更新的业务逻辑，对其他文档和代码进行同步调整，确保整个项目的一致性。

## 主要更新内容

### 1. 优化期望库存占比策略公式更新

#### 公式变更
原公式：
```
对于超出期望占比的标签：
Δ(k) = max(0, Current(k) - Expected(k))
W(k) = Δ(k) / Σ Δ(k')
```

新公式：
```
对于超出期望占比的标签：
W_raw(k) = 2 × Current(k) - Expected(k)  if Current(k) > Expected(k)
W_raw(k) = 0                               otherwise
W(k) = W_raw(k) / Σ W_raw(k')
```

#### 示例验证
- 期望分布（按张数）：大额50%, 中额40%, 小额10%
- 实际分布（按张数）：大额30%, 中额50%, 小额20%
- 计算结果：
  - 大额：0.3 < 0.5，权重 = 0
  - 中额：0.5 > 0.4，权重 = 2×0.5-0.4 = 0.6
  - 小额：0.2 > 0.1，权重 = 2×0.2-0.1 = 0.3
  - 归一化：大额0, 中额≈0.67, 小额≈0.33
  - 优先顺序：中额 > 小额 > 大额

#### 业务意义
新公式同时考虑当前总量和超出量，权重更能反映需要优先消耗的程度。

### 2. 库存分布计算方式明确

#### 关键变更
**明确库存分布按票据张数占比计算，而非金额占比。**

这是一个重要的澄清，确保与【智能配票算法逻辑.md】中"期望库存（张数）占比"的描述一致。

#### 代码修改
- 文件：`src/allocator.py`
- 位置：`_build_context` 方法
- 变更：从按金额占比改为按张数占比

修改前：
```python
total_amount = sum(t.amount for t in tickets)
label_sum = sum(t.amount for t in tickets if t.amount_label == label)
inventory_distribution[label] = label_sum / total_amount
```

修改后：
```python
total_count = len(tickets)
label_count = sum(1 for t in tickets if t.amount_label == label)
inventory_distribution[label] = Decimal(str(label_count)) / Decimal(str(total_count))
```

### 3. 文档更新清单

#### 更新的文件

1. **src/scoring.py**
   - 更新 `_score_optimize_inventory` 函数实现
   - 更新函数注释，明确按张数占比计算
   - 添加详细示例说明

2. **数学模型.md**
   - 更新"优化期望库存占比策略"章节
   - 修改公式定义
   - 添加"注意：库存占比按票据张数计算，而非金额"
   - 更新示例说明，标注"按张数占比"
   - 添加优先消耗顺序说明

3. **算法流程设计.md**
   - 在偏好得分计算章节添加优化库存占比策略的详细计算逻辑说明

4. **README.md**
   - 更新得分计算章节，明确"按张数"计算
   - 列出各维度支持的策略

5. **docs/使用指南.md**
   - 添加"优化期望库存占比策略说明"章节
   - 详细说明计算公式和示例
   - 明确标注"按张数占比"

6. **api/README.md**
   - 更新权重配置说明
   - 在金额策略描述中标注"按张数占比"

7. **src/allocator.py**
   - 修改 `_build_context` 方法中库存分布的计算逻辑

### 4. 测试验证

所有测试通过：
- ✓ `tests/test_basic.py` - 6个基础测试全部通过
- ✓ `tests/test_scenarios.py` - 10个场景测试全部通过

特别验证：
- 创建了专门的测试案例验证"优化库存占比"策略
- 确认按张数占比计算时，中额票（50%）和小额票（20%）优先于大额票（30%）被选择
- 符合期望分布（大额50%、中额40%、小额10%）的优化目标

### 5. 公式一致性确认

确认以下内容在所有文档和代码中保持一致：

✓ 优化期望库存占比策略的计算公式
✓ 库存分布按张数占比而非金额占比
✓ 示例计算结果与理论一致
✓ 代码实现与文档描述匹配

### 6. 其他保持不变的内容

以下内容保持原有逻辑，未作修改：
- 到期期限策略
- 承兑人分类策略
- 其他金额策略（大额优先、小额优先等）
- 承兑组织策略
- 拆票规则和约束
- 等额配票逻辑
- 批量配票流程

## 技术要点

1. **Decimal类型处理**：所有金额相关计算使用Decimal类型，避免浮点数精度问题
2. **归一化处理**：所有连续值维度均采用归一化得分，增大票据间差异
3. **时间复杂度**：核心算法保持O(n log n)的时间复杂度
4. **性能基准**：1万票据池在100ms内完成配票

## 兼容性说明

本次更新涉及核心评分逻辑的变更，但：
- 所有现有测试用例均能通过
- API接口保持不变
- 配置结构保持不变
- 对于不使用"优化库存占比"策略的用户，无任何影响

## 后续建议

1. 如有需要，可以考虑同时支持按金额占比和按张数占比两种模式
2. 建议在生产环境部署前，使用实际数据进行充分测试
3. 可以考虑添加配置项让用户选择占比计算方式

## 参考文档

- 【智能配票算法逻辑.md】：业务逻辑定义
- 【数学模型.md】：数学公式和模型
- 【算法流程设计.md】：算法流程说明
- 【README.md】：项目总体说明
- 【docs/使用指南.md】：详细使用文档
